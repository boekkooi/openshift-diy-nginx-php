#!/bin/bash

function build_phalcon() {
    local name=phalcon-v${PHALCON_VERSION}
    local pkg=${name}.tar.gz

    mkdir -p ${BUILD_DIR}
    pushd ${BUILD_DIR}

    # Get archive
    download_and_unpack ${pkg} https://github.com/phalcon/cphalcon/archive/${pkg} cphalcon-${name}
    pushd cphalcon-${name}/build

    # patch install
    sed \
        -e "s~phpize ~${ROOT_DIR}/php/bin/phpize ~g" \
        -e "s~./configure ~./configure --with-php-config=${ROOT_DIR}/php/bin/php-config ~g" \
        < install > openshift_install
    chmod +x openshift_install

    # Install PhalconPHP
    echo "Compiling Phalcon."
    ./openshift_install
    echo 'extension=phalcon.so' > ${OPENSHIFT_RUNTIME_DIR}/etc/php/conf.d/phalcon.ini

    echo "Cleaning build directory."
    popd
    popd
    rm -rf ${BUILD_DIR}
}

function check_phalcon() {
    local php_bin=${ROOT_DIR}/php/bin/php
    local phalcon_version=`${php_bin} -r "echo phpversion('phalcon');"`

    if [[ ${PHALCON_VERSION} != ${phalcon_version} ]]; then
        echo "Phalcon not installed or old version ${phalcon_version}"
        build_phalcon
    else
        echo "Phalcon up to date, version: ${phalcon_version}."
    fi
}

# Install phalcon when a version exists
if [ ! -z "${PHALCON_VERSION}" ]; then
    check_phalcon
fi
